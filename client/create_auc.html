<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Créez votre enchère</title>
    <style>
        .btn {
            background:#d1ab12; color:rgb(255, 255, 255); border:none; padding:0.6rem 0.8rem; border-radius:6px; cursor:pointer;
            font-weight:600; flex:1;display: inline-flex;align-items: center; justify-content: center;text-align: center;
        }
        .btn:active { transform:translateY(1px); }
        .error { color:#dc2626; font-size:0.82rem; margin-top:0.4rem; display:none; }

    </style>
    <script type="module" scr="js/request.js"> </script>
</head>
<body>
  <main style="max-width:720px;margin:2rem auto;padding:1.5rem;background:#fff;border-radius:10px;box-shadow:0 8px 24px rgba(15,23,42,0.06);">
    <h1 style="margin-top:0;text-align:center">Créer une enchère</h1>

    <form id="auctionForm" novalidate>
      <div style="margin-top:1rem;display:flex;flex-direction:column;gap:10px">
        <input id="title" name="title" placeholder="Titre de l'enchère" required style="padding:0.7rem;border:1px solid #e6eef7;border-radius:6px;font-size:1rem" />
         <div id="titleError" class="error">Ce champ est requis</div>

        <textarea id="description" name="description" placeholder="Description de l'objet" rows="4"
    style="padding:0.7rem;border:1px solid #e6eef7;border-radius:6px;font-size:1rem; resize: none; width:100%; box-sizing:border-box;"></textarea>
         <div id="descriptionError" class="error">Ce champ est requis</div>

        <input id="startPrice" name="startPrice" type="number" min="0" step="0.01" placeholder="Prix de départ (€)" style="padding:0.7rem;border:1px solid #e6eef7;border-radius:6px;font-size:1rem" />
         <div id="startPriceError" class="error">Ce champ est requis</div>

      <label for="endDate" style="font-size:0.85rem;color:#000000;margin-top:6px">Date et heure de fin</label>
    <input id="endDate" name="endDate" type="datetime-local" required
         style="padding:0.7rem;border:1px solid #e6eef7;border-radius:6px;font-size:1rem;width:100%;box-sizing:border-box" />
         <div id="dateError" class="error">Ce champ est requis</div>
    <div id="endDateError" style="color:#dc2626;font-size:0.85rem;display:none">La date de fin doit être dans le futur.</div>
</div>
    </div>

      <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:1rem">
        <a href="index.html" class="btn secondary" role="button">Annuler</a>
        <button id="submit" type="button" class="btn">Publier</button>
      </div>
    </form>
  </main>

  <script type="module">
    import {createAuctionRequest} from './js/request.js'
    const MAX_SIZE = 7 * 1024 * 1024; // 7 Mo en octets 
    const submit = document.getElementById('submit');
    const title = document.getElementById('title'); 
    const description = document.getElementById('description');
    const price = document.getElementById('startPrice')
    const date = document.getElementById('endDate')
    const titleError = document.getElementById('titleError')
    const descriptionError = document.getElementById('descriptionError')
    const priceError = document.getElementById('startPriceError')
    const dateError = document.getElementById('dateError')
    const endDateError = document.getElementById("endDateError")
    const imageError = document.getElementById('imageError')

    let currentFile = null;

    function validateForm(){
      let ok = true;
      if (title.value.trim().length == 0) {titleError.style.display = 'block'; ok = false;}
      else {titleError.style.display = 'none';}
      if (description.value.trim().length == 0) {descriptionError.style.display = 'block'; ok = false;}
      else {descriptionError.style.display = 'none'}
      if (price.value <= 0) {priceError.style.display = 'block'; ok = false}
      else {priceError.style.display = 'none';}
      if (!date.value) {dateError.style.display = 'block'; ok = false;}
      else if(new Date(date.value) <= new Date()) { 
        dateError.style.display = 'none';
        endDateError.style.display = 'block'
        ok = false;
      }
      else {
        dateError.style.display = 'none';
        endDateError.style.display = 'none'
      }
      return ok;

    }

    async function submitForm(){
      if (validateForm()){
        let data = JSON.parse(
          await createAuctionRequest(
            title.value, 
            description.value, 
            price.value, 
            Math.floor(new Date(date.value).getTime() / 1000)
          )
        );
        if (Object.hasOwn(data, "detail")){
          console.log(`${data.detail.status} ${data.detail.code} : ${data.detail.message}`)
          if (data.detal.code == 13 || data.detail.code == 14) window.location.href="login.html";
        }
        else {
          let json = JSON.parse(data.message);
          window.location.href= `auction.html?id=${json.id}`;
        }
      }
    }

    
    // bouton Parcourir ouvre le file picker
    browseBtn.addEventListener('click', (e) => {
      e.preventDefault();
      fileInput.click();
    });

    // cliquer sur la zone de dépôt ouvre le file picker
    // dropZone.addEventListener('click', () => fileInput.click());

    // selection via file input
    fileInput.addEventListener('change', (e) => {
      handleFile(e.target.files[0]);
      fileInput.value = '';
    });

    removeBtn.addEventListener('click', () => {
      previewContainer.style.display = 'none';
      previewImage.src = '';
      currentFile = null;
      clearError();
    });


    
    submit.onclick = await submitForm;


  </script>
</body>