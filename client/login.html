<!doctype html>
<html lang="fr">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Connexion √† AS</title>
    <style>
        :root { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; color-scheme: light; }
        body { display:flex; align-items:center; justify-content:center; min-height:100vh; margin:0; background:#f3f4f6; }
        .card { background:#fff; padding:2rem; border-radius:10px; box-shadow:0 6px 20px rgba(15,23,42,0.08); width:320px; }
        h1 { margin:0 0 1rem 0; font-size:1.25rem; text-align:center; color:black; }
        .field { margin-bottom:0.9rem; }
        label { display:block; font-size:0.85rem; margin-bottom:0.3rem; color:gray; }
        input[type="text"], input[type="password"] {
            width:100%; padding:0.6rem 0.7rem; border:1px solid #cbd5e1; border-radius:6px; font-size:0.95rem;
            box-sizing:border-box;
        }
        .controls { display:flex; gap:0.5rem; align-items:center; }
        .btn {
            background:#d1ab12; color:rgb(255, 255, 255); border:none; padding:0.6rem 0.8rem; border-radius:6px; cursor:pointer;
            font-weight:600; flex:1;display: inline-flex;align-items: center; justify-content: center;text-align: center;
        }
        .btn:active { transform:translateY(1px); } 
        .secondary { background:rgb(218, 218, 218); color:black; }
        .help { font-size:0.82rem; color:gray; margin-top:0.6rem; text-align:center; }
        .error { color:red; font-size:0.82rem; margin-top:0.4rem; display:none; }
        .incorrect { color:red; font-size:0.82rem; margin-top:0.4rem; display:none; }
        .show-pass { background:transparent; border:1px solid #cbd5e1; padding:0.45rem 0.6rem; border-radius:6px; cursor:pointer; } /* bouton afficher/masquer le mot de passe */
    </style>
</head>
<body>
    <main class="card" aria-labelledby="title">
        <h1 id="title">Se connecter</h1>

        <img src="AS_logo.png" alt="logo" style="display:block; margin:0 auto 1rem auto; width:100px; height:auto;" />

        <form id="loginForm" novalidate>
            <div class="field">
                <label for="pseudo">Pseudo</label>
                <input id="pseudo" name="pseudo" type="text" placeholder="Entrez votre pseudo" minlength="3" maxlength="50" required autocomplete="username" />
                <div class="incorrect" id="pseudoIncorrect">Le pseudo est incorrect</div>
                <div class="error" id="pseudoError">Le pseudo doit contenir au moins 3 caract√®res.</div>
            </div>

            <div class="field">
                <label for="password">Mot de passe</label>
                <div style="display:flex; gap:0.5rem; align-items:center;">
                    <input id="password" name="password" type="password" placeholder="Entrez votre mot de passe" minlength="6" required autocomplete="current-password" style="flex:1" />
                    <button type="button" id="togglePass" class="show-pass" aria-pressed="false" title="Afficher / masquer le mot de passe">üëÅÔ∏è</button>
                </div>
                <div class="incorrect" id="passwordIncorrect">Le mot de passe est incorrect</div>
                <div class="error" id="passwordError">Le mot de passe doit contenir au moins 6 caract√®res.</div>
            </div>

            <div class="field controls">
                <button id="submit" class="btn" type="button">Connexion</button>
                <a class="btn secondary" href="create.html" role="button">Create</a>
            </div>

            <div class="help">Pas encore de compte ? Cliquez sur Create pour en cr√©er un !</div>
        </form>
    </main>
    
    <script type="module">
        import {loginRequest, getServerKey} from './js/request.js'
        import {rsaVerify} from './js/security.js'

        const form = document.getElementById('loginForm');
        const pseudo = document.getElementById('pseudo');
        const password = document.getElementById('password');
        const pseudoError = document.getElementById('pseudoError');
        const pseudoIncorrect = document.getElementById('pseudoIncorrect');
        const passwordError = document.getElementById('passwordError');
        const passwordIncorrect = document.getElementById('passwordIncorrect');
        const toggle = document.getElementById('togglePass');
        const submit = document.getElementById('submit');

        toggle.addEventListener('click', () => {
            const isHidden = password.type === 'password';
            password.type = isHidden ? 'text' : 'password';
            toggle.setAttribute('aria-pressed', String(isHidden));
            toggle.textContent = isHidden ? 'üôà' : 'üëÅÔ∏è';
        });

        function validateField() {
            let ok = true;
            if (pseudo.value.trim().length < 3 && pseudo.value.trim().length > 25) {
                pseudoError.style.display = 'block'; ok = false;
            } else { pseudoError.style.display = 'none'; }
            if (password.value.length < 6 && password.value.length > 30) {
                passwordError.style.display = 'block'; ok = false;
            } else { passwordError.style.display = 'none'; }
            return ok;
        }


        form.addEventListener('input', () => { validateField(); });

        async function submitForm(){
            if (validateField()){
                let data = JSON.parse(
                    await loginRequest(pseudo.value, password.value),
                    (key, value, context) => {
                        if (key == "signature"){
                            return BigInt(context.source);
                        }
                        return value;
                    }
                );
                if (Object.hasOwn(data, "detail")){
                    console.log(`${data.detail.status} ${data.detail.code} : ${data.detail.message}`)
                    pseudoError.style.display = 'none';
                    passwordError.style.display = 'none';
                    pseudoIncorrect.style.display = 'block';
                    passwordIncorrect.style.display = 'block';
                }
                else if (rsaVerify(data.message, data.signature, getServerKey()) == false){
                    console.log("This request is not from the server");
                }
                else {
                    let message = JSON.parse(data.message);
                    localStorage.setItem("token", message.access_token);
                    window.location.href = "index.html";
                }
            }
        }

        submit.onclick = await submitForm;

    </script>
</body>
</html></div>